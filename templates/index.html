{% extends "base.html" %}
{% block title %}Club House{% endblock %}

{% block content %}
<div class="club-management-container">
  <!-- Header -->
  <div class="header-section d-flex justify-content-between align-items-center mb-4">
    <h1 class="page-title">Club House</h1>
    <div class="d-flex gap-2">
      <a href="{{ url_for('students') }}" class="btn btn-outline-secondary">
        <i class="bi bi-people"></i> Students
      </a>
      <button type="button" class="btn btn-info btn-sm" id="createSampleBtn" title="Create sample data for testing">
        <i class="bi bi-database-add"></i> Sample Data
      </button>
      <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createClubModal">
        <i class="bi bi-plus-lg"></i> Create Club
      </button>
    </div>
  </div>

  <!-- Search -->
  <div class="search-section mb-4">
    <div class="search-container">
      <div class="input-group">
        <span class="input-group-text bg-white border-end-0">
          <i class="bi bi-search text-muted"></i>
        </span>
        <input id="searchInput" type="text" class="form-control border-start-0 ps-0" placeholder="Search clubs..." value="{{ search_query or '' }}">
      </div>
    </div>
  </div>

  <!-- Clubs Grid -->
  <div id="clubsContainer" class="grid">
    {% if clubs %}
      {% for club in clubs %}
      <div class="card club-card" data-club-id="{{ club.id }}">
        <div class="club-card-header d-flex justify-content-between align-items-start">
          <div style="flex:1">
            <h3 class="club-name">{{ club.name }}</h3>
            <p class="club-description">{{ club.description or '' }}</p>
          </div>
          <div class="club-actions">
            <button class="btn btn-link text-muted edit-club-btn" data-club-id="{{ club.id }}"><i class="bi bi-pencil"></i></button>
            <button class="btn btn-link text-danger delete-club-btn" data-club-id="{{ club.id }}"><i class="bi bi-trash"></i></button>
          </div>
        </div>

        <div class="club-footer d-flex justify-content-between align-items-center">
          <div class="member-count">
            <i class="bi bi-people"></i>
            <span class="ms-2">{{ club.member_count or 0 }} member{{ 's' if (club.member_count or 0) != 1 else '' }}</span>
          </div>
          <a class="btn btn-outline-primary btn-sm" href="{{ url_for('club_roster', club_id=club.id) }}">
            <i class="bi bi-eye"></i> View Roster
          </a>
        </div>
      </div>
      {% endfor %}
    {% else %}
      <div class="no-clubs-message text-center py-5 w-100">
        <i class="bi bi-collection text-muted" style="font-size: 3rem;"></i>
        <h3 class="text-muted mt-3">No clubs found</h3>
        <p class="text-muted">
          {% if search_query %}
            No clubs match your search "{{ search_query }}".
          {% else %}
            Get started by creating your first club!
          {% endif %}
        </p>
        {% if not search_query %}
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createClubModal">
          <i class="bi bi-plus-lg"></i> Create Your First Club
        </button>
        {% else %}
        <button id="clearClubFilterBtn" class="btn btn-outline-secondary">Clear Filter</button>
        {% endif %}
      </div>
    {% endif %}
  </div>
</div>

<!-- Create Club Modal -->
<div class="modal fade" id="createClubModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form id="createClubForm">
        <div class="modal-header"><h5 class="modal-title">Create New Club</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <div class="mb-3"><label class="form-label">Club Name</label><input id="clubName" name="name" class="form-control" required></div>
          <div class="mb-3"><label class="form-label">Description</label><textarea id="clubDescription" name="description" class="form-control" rows="4" required></textarea></div>
        </div>
        <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button type="submit" class="btn btn-primary">Create Club</button></div>
      </form>
    </div>
  </div>
</div>

<!-- Edit Club Modal -->
<div class="modal fade" id="editClubModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form id="editClubForm"><input type="hidden" id="editClubId" name="club_id"/>
        <div class="modal-header"><h5 class="modal-title">Edit Club</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <div class="mb-3"><label class="form-label">Club Name</label><input id="editClubName" name="name" class="form-control" required></div>
          <div class="mb-3"><label class="form-label">Description</label><textarea id="editClubDescription" name="description" class="form-control" rows="4" required></textarea></div>
        </div>
        <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button class="btn btn-primary" type="submit">Update Club</button></div>
      </form>
    </div>
  </div>
</div>

<!-- Delete Confirm Modal -->
<div class="modal fade" id="deleteClubModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title">Delete Club</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
    <div class="modal-body"><p>Are you sure you want to delete this club? This action cannot be undone.</p></div>
    <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button id="confirmDeleteBtn" class="btn btn-danger">Delete Club</button></div>
  </div></div>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay" style="display:none;">
  <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function(){
  const searchInput = document.getElementById('searchInput');
  const createClubForm = document.getElementById('createClubForm');
  const editClubForm = document.getElementById('editClubForm');
  const createSampleBtn = document.getElementById('createSampleBtn');
  let currentDeleteClubId = null;

  function showLoading(){ document.getElementById('loadingOverlay').style.display = 'flex'; }
  function hideLoading(){ document.getElementById('loadingOverlay').style.display = 'none'; }
  function showAlert(msg, type='success'){ const div=document.createElement('div'); div.className=`alert alert-${type==='error'?'danger':type} alert-dismissible fade show`; div.innerHTML=`${msg}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`; document.querySelector('.club-management-container').prepend(div); setTimeout(()=>div.remove(),5000); }

  // search update URL
  let timer;
  searchInput.addEventListener('input', function(){
    clearTimeout(timer);
    timer = setTimeout(()=> {
      const q = this.value.trim();
      const url = new URL(window.location);
      if (q) url.searchParams.set('search', q); else url.searchParams.delete('search');
      window.location.href = url.toString();
    }, 400);
  });

  // create club
  createClubForm.addEventListener('submit', function(e){
    e.preventDefault();
    const name = document.getElementById('clubName').value.trim();
    const desc = document.getElementById('clubDescription').value.trim();
    if(!name || !desc){ showAlert('Name and description required','error'); return; }
    showLoading();
    fetch('/api/clubs', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({name, description: desc}) })
      .then(r=>r.json()).then(res=>{ hideLoading(); if(res.success){ showAlert('Club created','success'); setTimeout(()=>window.location.reload(),700);} else showAlert(res.error||'Failed','error') })
      .catch(()=>{ hideLoading(); showAlert('Error','error') });
  });

  // delegated edit/delete handlers
  document.addEventListener('click', function(e){
    const edit = e.target.closest('.edit-club-btn');
    if(edit){ e.preventDefault(); const id = edit.dataset.clubId; loadClubForEdit(id); return; }
    const del = e.target.closest('.delete-club-btn');
    if(del){ e.preventDefault(); currentDeleteClubId = del.dataset.clubId; const modal = new bootstrap.Modal(document.getElementById('deleteClubModal')); modal.show(); return; }
    if(e.target && e.target.id === 'clearClubFilterBtn'){ const url = new URL(window.location); url.searchParams.delete('search'); history.pushState(null,'',url); window.location.href = url.toString(); }
  });

  function loadClubForEdit(id){
    showLoading();
    fetch(`/api/clubs/${id}`).then(r=>r.json()).then(res=>{ hideLoading(); if(res.success){ document.getElementById('editClubId').value = id; document.getElementById('editClubName').value = res.club.name; document.getElementById('editClubDescription').value = res.club.description || ''; const modal = new bootstrap.Modal(document.getElementById('editClubModal')); modal.show(); } else showAlert(res.error,'error'); }).catch(()=>{ hideLoading(); showAlert('Error','error'); });
  }

  editClubForm.addEventListener('submit', function(e){
    e.preventDefault();
    const id = document.getElementById('editClubId').value;
    const name = document.getElementById('editClubName').value.trim();
    const desc = document.getElementById('editClubDescription').value.trim();
    if(!name||!desc){ showAlert('Name and description required','error'); return; }
    showLoading();
    fetch(`/api/clubs/${id}`, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({name, description: desc}) })
      .then(r=>r.json()).then(res=>{ hideLoading(); if(res.success){ showAlert('Club updated','success'); setTimeout(()=>window.location.reload(),700);} else showAlert(res.error||'Failed','error') }).catch(()=>{ hideLoading(); showAlert('Error','error') });
  });

  // confirm delete (optimistic + rollback)
  document.getElementById('confirmDeleteBtn').addEventListener('click', function(){
    if(!currentDeleteClubId) return;
    const card = document.querySelector(`.club-card[data-club-id="${currentDeleteClubId}"]`);
    if(!card) return;
    const backup = card.cloneNode(true);
    const parent = card.parentNode;
    const idx = Array.from(parent.children).indexOf(card);
    // optimistic remove
    card.remove();
    showLoading();
    fetch(`/api/clubs/${currentDeleteClubId}`, { method:'DELETE' })
      .then(r=>r.json()).then(res=>{ hideLoading(); if(res.success){ const modal = bootstrap.Modal.getInstance(document.getElementById('deleteClubModal')); if(modal) modal.hide(); showAlert('Club deleted','success'); } else { if(idx >= parent.children.length) parent.appendChild(backup); else parent.insertBefore(backup, parent.children[idx]); showAlert(res.error||'Failed','error'); } })
      .catch(err=>{ hideLoading(); if(idx >= parent.children.length) parent.appendChild(backup); else parent.insertBefore(backup, parent.children[idx]); showAlert('Network error','error'); console.error(err); });
  });

  // sample data
  createSampleBtn.addEventListener('click', function(){ if(!confirm('Create sample data?')) return; showLoading(); fetch('/api/create-sample-data',{ method:'POST' }).then(r=>r.json()).then(res=>{ hideLoading(); if(res.success){ showAlert(res.message,'success'); setTimeout(()=>window.location.reload(),800);} else showAlert(res.error||'Failed','error') }).catch(()=>{ hideLoading(); showAlert('Error','error') }) });

});
</script>
{% endblock %}