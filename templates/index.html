{% extends "base.html" %}

{% block title %}Club House{% endblock %}

{% block content %}
<div class="club-management-container">
    <!-- Header -->
    <div class="header-section d-flex justify-content-between align-items-center mb-4">
        <h1 class="page-title">Club House</h1>
        <div class="d-flex gap-2">
            <a href="{{ url_for('students') }}" class="btn btn-outline-secondary">
                <i class="bi bi-people"></i> Students
            </a>
            <button type="button" class="btn btn-info btn-sm create-sample-btn" id="createSampleBtn" title="Create sample data for testing">
                <i class="bi bi-database-add"></i> Sample Data
            </button>
            <button type="button" class="btn btn-primary create-club-btn" data-bs-toggle="modal" data-bs-target="#createClubModal">
                <i class="bi bi-plus-lg"></i> Create Club
            </button>
        </div>
    </div>

    <!-- Search Bar -->
    <div class="search-section mb-4">
        <div class="search-container">
            <div class="input-group">
                <span class="input-group-text bg-white border-end-0">
                    <i class="bi bi-search text-muted"></i>
                </span>
                <input type="text" class="form-control border-start-0 ps-0" id="searchInput" 
                       placeholder="Search clubs..." value="{{ search_query or '' }}">
            </div>
        </div>
    </div>

    <!-- Clubs Grid -->
    <div class="clubs-grid" id="clubsContainer">
        {% if clubs %}
            {% for club in clubs %}
            <div class="club-card" data-club-id="{{ club.id }}">
                <div class="club-card-header">
                    <h3 class="club-name">{{ club.name }}</h3>
                    <div class="club-actions dropdown">
                        <button class="btn btn-link p-0 text-muted" type="button" data-bs-toggle="dropdown">
                            <i class="bi bi-three-dots-vertical"></i>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item edit-club-btn" href="#" data-club-id="{{ club.id }}">
                                <i class="bi bi-pencil"></i> Edit
                            </a></li>
                            <li><a class="dropdown-item text-danger delete-club-btn" href="#" data-club-id="{{ club.id }}">
                                <i class="bi bi-trash"></i> Delete
                            </a></li>
                        </ul>
                    </div>
                </div>
                
                <p class="club-description">{{ club.description }}</p>
                
                <div class="club-footer">
                    <div class="member-count">
                        <i class="bi bi-people"></i>
                        <span>{{ club.member_count or 0 }} member{{ 's' if (club.member_count or 0) != 1 else '' }}</span>
                    </div>
                    
                    <a href="{{ url_for('club_roster', club_id=club.id) }}" class="btn btn-outline-primary btn-sm view-roster-btn">
                        <i class="bi bi-eye"></i> View Roster
                    </a>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="no-clubs-message text-center py-5">
                <i class="bi bi-collection text-muted" style="font-size: 3rem;"></i>
                <h3 class="text-muted mt-3">No clubs found</h3>
                <p class="text-muted">
                    {% if search_query %}
                        No clubs match your search "{{ search_query }}".
                    {% else %}
                        Get started by creating your first club!
                    {% endif %}
                </p>
                {% if not search_query %}
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createClubModal">
                    <i class="bi bi-plus-lg"></i> Create Your First Club
                </button>
                {% endif %}
            </div>
        {% endif %}
    </div>
</div>

<!-- Create Club Modal -->
<div class="modal fade" id="createClubModal" tabindex="-1" aria-labelledby="createClubModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createClubModalLabel">Create New Club</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="createClubForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="clubName" class="form-label">Club Name</label>
                        <input type="text" class="form-control" id="clubName" name="name" required 
                               placeholder="Enter club name">
                    </div>
                    <div class="mb-3">
                        <label for="clubDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="clubDescription" name="description" rows="4" required
                                  placeholder="Enter club description"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Club</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Club Modal -->
<div class="modal fade" id="editClubModal" tabindex="-1" aria-labelledby="editClubModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editClubModalLabel">Edit Club</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editClubForm">
                <div class="modal-body">
                    <input type="hidden" id="editClubId" name="club_id">
                    <div class="mb-3">
                        <label for="editClubName" class="form-label">Club Name</label>
                        <input type="text" class="form-control" id="editClubName" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="editClubDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="editClubDescription" name="description" rows="4" required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Club</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteClubModal" tabindex="-1" aria-labelledby="deleteClubModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteClubModalLabel">Delete Club</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this club? This action cannot be undone.</p>
                <p class="text-muted">All members will be removed from the club.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete Club</button>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay" style="display: none;">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    const createClubForm = document.getElementById('createClubForm');
    const editClubForm = document.getElementById('editClubForm');
    const createClubModal = new bootstrap.Modal(document.getElementById('createClubModal'));
    const editClubModal = new bootstrap.Modal(document.getElementById('editClubModal'));
    const deleteClubModal = new bootstrap.Modal(document.getElementById('deleteClubModal'));
    const loadingOverlay = document.getElementById('loadingOverlay');
    
    let currentDeleteClubId = null;

    // Search functionality
    let searchTimeout;
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            const query = this.value.trim();
            const url = new URL(window.location);
            if (query) {
                url.searchParams.set('search', query);
            } else {
                url.searchParams.delete('search');
            }
            window.location.href = url.toString();
        }, 500);
    });

    // Create club form submission
    createClubForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const data = {
            name: formData.get('name'),
            description: formData.get('description')
        };

        showLoading();
        
        fetch('/api/clubs', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            hideLoading();
            if (result.success) {
                createClubModal.hide();
                showAlert('Club created successfully!', 'success');
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                showAlert(result.error || 'Failed to create club', 'error');
            }
        })
        .catch(error => {
            hideLoading();
            console.error('Error:', error);
            showAlert('An error occurred while creating the club', 'error');
        });
    });

    // Edit club buttons
    document.addEventListener('click', function(e) {
        if (e.target.closest('.edit-club-btn')) {
            e.preventDefault();
            const clubId = e.target.closest('.edit-club-btn').dataset.clubId;
            loadClubForEdit(clubId);
        }
        
        if (e.target.closest('.delete-club-btn')) {
            e.preventDefault();
            const clubId = e.target.closest('.delete-club-btn').dataset.clubId;
            currentDeleteClubId = clubId;
            deleteClubModal.show();
        }
    });

    // Load club data for editing
    function loadClubForEdit(clubId) {
        showLoading();
        
        fetch(`/api/clubs/${clubId}`)
        .then(response => response.json())
        .then(result => {
            hideLoading();
            if (result.success) {
                document.getElementById('editClubId').value = clubId;
                document.getElementById('editClubName').value = result.club.name;
                document.getElementById('editClubDescription').value = result.club.description;
                editClubModal.show();
            } else {
                showAlert(result.error || 'Failed to load club data', 'error');
            }
        })
        .catch(error => {
            hideLoading();
            console.error('Error:', error);
            showAlert('An error occurred while loading club data', 'error');
        });
    }

    // Edit club form submission
    editClubForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const clubId = document.getElementById('editClubId').value;
        const formData = new FormData(this);
        const data = {
            name: formData.get('name'),
            description: formData.get('description')
        };

        showLoading();
        
        fetch(`/api/clubs/${clubId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            hideLoading();
            if (result.success) {
                editClubModal.hide();
                showAlert('Club updated successfully!', 'success');
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                showAlert(result.error || 'Failed to update club', 'error');
            }
        })
        .catch(error => {
            hideLoading();
            console.error('Error:', error);
            showAlert('An error occurred while updating the club', 'error');
        });
    });

    // Delete club confirmation
    document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
        if (!currentDeleteClubId) return;

        showLoading();
        
        fetch(`/api/clubs/${currentDeleteClubId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(result => {
            hideLoading();
            if (result.success) {
                deleteClubModal.hide();
                showAlert('Club deleted successfully!', 'success');
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                showAlert(result.error || 'Failed to delete club', 'error');
            }
        })
        .catch(error => {
            hideLoading();
            console.error('Error:', error);
            showAlert('An error occurred while deleting the club', 'error');
        });
    });

    // Create sample data
    document.getElementById('createSampleBtn').addEventListener('click', function() {
        if (!confirm('This will create sample clubs and students for testing. Continue?')) {
            return;
        }

        showLoading();
        
        fetch('/api/create-sample-data', {
            method: 'POST'
        })
        .then(response => response.json())
        .then(result => {
            hideLoading();
            if (result.success) {
                showAlert(result.message, 'success');
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            } else {
                showAlert(result.error || 'Failed to create sample data', 'error');
            }
        })
        .catch(error => {
            hideLoading();
            console.error('Error:', error);
            showAlert('An error occurred while creating sample data', 'error');
        });
    });

    // Reset forms when modals are hidden
    document.getElementById('createClubModal').addEventListener('hidden.bs.modal', function() {
        createClubForm.reset();
    });

    document.getElementById('editClubModal').addEventListener('hidden.bs.modal', function() {
        editClubForm.reset();
    });

    // Utility functions
    function showLoading() {
        loadingOverlay.style.display = 'flex';
    }

    function hideLoading() {
        loadingOverlay.style.display = 'none';
    }

    function showAlert(message, type) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type === 'error' ? 'danger' : 'success'} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        const container = document.querySelector('.club-management-container');
        container.insertBefore(alertDiv, container.firstChild);
        
        // Auto-dismiss after 5 seconds
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    }
});
</script>
{% endblock %}
