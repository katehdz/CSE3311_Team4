{% extends "base.html" %}

{% block title %}{{ club.name }} - Roster{% endblock %}

{% block content %}
<div class="roster-container">
  <!-- Header -->
  <div class="header-section d-flex justify-content-between align-items-center mb-4">
    <div>
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb mb-2">
          <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Club House</a></li>
          <li class="breadcrumb-item active">{{ club.name }}</li>
        </ol>
      </nav>

      <h1 class="page-title">{{ club.name }} Roster</h1>
      <p class="text-muted">{{ club.description or '' }}</p>
    </div>

    <div class="d-flex gap-2 align-items-center">
      <select id="roleFilter" class="form-select form-select-sm w-auto me-2">
        <option value="">All Roles</option>
        <option value="President" {% if selected_role == 'President' %}selected{% endif %}>President</option>
        <option value="Officer" {% if selected_role == 'Officer' %}selected{% endif %}>Officer</option>
        <option value="Vice President" {% if selected_role == 'Vice President' %}selected{% endif %}>Vice President</option>
        <option value="Treasurer" {% if selected_role == 'Treasurer' %}selected{% endif %}>Treasurer</option>
        <option value="Secretary" {% if selected_role == 'Secretary' %}selected{% endif %}>Secretary</option>
        <option value="Member" {% if selected_role == 'Member' %}selected{% endif %}>Member</option>
      </select>

      <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addMemberModal">
        <i class="bi bi-person-plus"></i> Add Member
      </button>

      <a class="btn btn-secondary" href="{{ url_for('index') }}">
        <i class="bi bi-arrow-left"></i> Back to Clubs
      </a>
    </div>
  </div>

  <!-- Member Statistics -->
  <div class="row mb-4">
    <div class="col-md-3 col-sm-6 mb-3">
      <div class="stat-card">
        <div class="stat-icon"><i class="bi bi-people"></i></div>
        <div class="stat-info">
          <h3 id="statTotalMembers">{{ members|length }}</h3>
          <p>Total Members</p>
        </div>
      </div>
    </div>

    <div class="col-md-3 col-sm-6 mb-3">
      <div class="stat-card">
        <div class="stat-icon"><i class="bi bi-star"></i></div>
        <div class="stat-info">
          <h3 id="statOfficers">
            {{ members|selectattr('role','equalto','President')|list|length + members|selectattr('role','equalto','Officer')|list|length }}
          </h3>
          <p>Officers</p>
        </div>
      </div>
    </div>

    <div class="col-md-3 col-sm-6 mb-3">
      <div class="stat-card">
        <div class="stat-icon"><i class="bi bi-person-check"></i></div>
        <div class="stat-info">
          <h3 id="statRegularMembers">{{ members|selectattr('role','equalto','Member')|list|length }}</h3>
          <p>Regular Members</p>
        </div>
      </div>
    </div>

    <div class="col-md-3 col-sm-6 mb-3">
      <div class="stat-card">
        <div class="stat-icon"><i class="bi bi-calendar-plus"></i></div>
        <div class="stat-info">
          <h3 id="statLatestJoin">{{ (members|map(attribute='join_date')|list|sort|reverse|first)[:10] if members else 'N/A' }}</h3>
          <p>Latest Join</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Members List -->
  <div class="members-section">
    <div class="section-header d-flex justify-content-between align-items-center mb-3">
      <h3>Members</h3>
      <div class="d-flex gap-2 align-items-center">
        <div class="input-group" style="max-width: 300px;">
          <span class="input-group-text bg-white border-end-0"><i class="bi bi-search text-muted"></i></span>
          <input id="memberSearchInput" type="text" class="form-control border-start-0 ps-0" placeholder="Search members...">
        </div>
        
        <!-- Quick filter buttons -->
        <div class="btn-group btn-group-sm" role="group" aria-label="Role filters">
          <button type="button" class="btn btn-outline-secondary quick-filter-btn" data-role="">All</button>
          <button type="button" class="btn btn-outline-secondary quick-filter-btn" data-role="Member">Members</button>
          <button type="button" class="btn btn-outline-secondary quick-filter-btn" data-role="Officer">Officers</button>
        </div>
      </div>
    </div>

    {% if members %}
      <div id="membersContainer" class="members-grid">
        {% for member in members %}
        <div class="member-card"
             data-member-id="{{ member.id }}"
             data-member-name="{{ (member.name or '')|lower }}"
             data-member-role="{{ (member.role or '')|lower }}">
          <div class="member-avatar"><i class="bi bi-person-circle"></i></div>

          <div class="member-info">
            <h4 class="member-name">{{ member.name or '—' }}</h4>
            <p class="member-email">
              <a href="mailto:{{ (member.email or '') }}">{{ member.email or '—' }}</a>
              <button class="btn btn-sm btn-outline-secondary copy-email-btn ms-2" data-email="{{ (member.email or '') }}" type="button" title="Copy email">
                <i class="bi bi-clipboard"></i>
              </button>
            </p>

            <div class="member-details">
              <span class="role-badge role-{{ (member.role or '')|lower|replace(' ', '-') }}">{{ member.role or 'Member' }}</span>
              <span class="join-date"><i class="bi bi-calendar3"></i> Joined {{ (member.join_date or '')[:10] }}</span>
            </div>
          </div>

          <div class="member-actions dropdown">
            <button class="btn btn-link p-0 text-muted" type="button" data-bs-toggle="dropdown">
              <i class="bi bi-three-dots-vertical"></i>
            </button>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item edit-role-btn" href="#" data-member-id="{{ member.id }}" data-current-role="{{ member.role }}"><i class="bi bi-pencil"></i> Change Role</a></li>
              <li><a class="dropdown-item text-danger remove-member-btn" href="#" data-member-id="{{ member.id }}" data-member-name="{{ member.name }}"><i class="bi bi-person-dash"></i> Remove Member</a></li>
            </ul>
          </div>
        </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="no-members-message text-center py-5">
        <i class="bi bi-people text-muted" style="font-size: 3rem;"></i>
        <h3 class="text-muted mt-3">No members yet</h3>
        <p class="text-muted">Start building your club by adding the first member!</p>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addMemberModal"><i class="bi bi-person-plus"></i> Add First Member</button>
      </div>
    {% endif %}
  </div>
</div>

<!-- Add Member Modal -->
<div class="modal fade" id="addMemberModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form id="addMemberForm">
        <div class="modal-header"><h5 class="modal-title">Add Member to {{ club.name }}</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Student</label>
            <select id="studentSelect" name="student_id" class="form-select" required>
              <option value="">Choose a student...</option>
              {% for s in students %}
                {% if s.email %}
                  <option value="{{ s.id }}">{{ s.name }} ({{ s.email }})</option>
                {% else %}
                  <option value="{{ s.id }}">{{ s.name }} (No email)</option>
                {% endif %}
              {% endfor %}
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Role</label>
            <select id="memberRole" name="role" class="form-select" required>
              <option value="Member">Member</option>
              <option value="Officer">Officer</option>
              <option value="Vice President">Vice President</option>
              <option value="Treasurer">Treasurer</option>
              <option value="Secretary">Secretary</option>
              <option value="President">President</option>
            </select>
          </div>
        </div>
        <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button class="btn btn-primary" type="submit">Add Member</button></div>
      </form>
    </div>
  </div>
</div>

<!-- Edit Role Modal -->
<div class="modal fade" id="editRoleModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form id="editRoleForm">
        <div class="modal-header"><h5 class="modal-title">Change Member Role</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <input type="hidden" id="editMemberId" name="member_id">
          <div class="mb-3">
            <label class="form-label">New Role</label>
            <select id="editMemberRole" name="role" class="form-select" required>
              <option value="Member">Member</option>
              <option value="Officer">Officer</option>
              <option value="Vice President">Vice President</option>
              <option value="Treasurer">Treasurer</option>
              <option value="Secretary">Secretary</option>
              <option value="President">President</option>
            </select>
          </div>
        </div>
        <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button class="btn btn-primary" type="submit">Update Role</button></div>
      </form>
    </div>
  </div>
</div>

<!-- Remove Member Modal -->
<div class="modal fade" id="removeMemberModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Remove Member</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <p>Are you sure you want to remove <strong id="removeMemberName"></strong> from this club?</p>
        <p class="text-muted">This action cannot be undone.</p>
      </div>
      <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button id="confirmRemoveBtn" class="btn btn-danger">Remove Member</button></div>
    </div>
  </div>
</div>

<div class="mb-3">
  <label for="memberRole" class="form-label">Role</label>
  <select class="form-select" id="memberRole" name="role" required>
    <option value="">Select a role...</option>
    <option value="Member">Member</option>
    <option value="Officer">Officer</option>
    <option value="Vice President">Vice President</option>
    <option value="Treasurer">Treasurer</option>
    <option value="Secretary">Secretary</option>
    <option value="President">President</option>
  </select>
  <div class="invalid-feedback" id="memberRoleFeedback">Please select a role.</div>
</div>


<!-- Members List -->
  <div class="members-section">
    <div class="section-header d-flex justify-content-between align-items-center mb-3">
      <h3>Members</h3>
      <div class="input-group" style="max-width: 420px;">
        <span class="input-group-text bg-white border-end-0"><i class="bi bi-search text-muted"></i></span>
        <input id="memberSearchInput" type="text" class="form-control border-start-0 ps-0" placeholder="Search members...">
      </div>
    </div>

    <!-- container where member cards or empty state will be rendered -->
    <div id="membersContainer" class="members-grid">
      {% if members %}
        {% for member in members %}
        <div class="member-card"
             data-member-id="{{ member.id }}"
             data-member-name="{{ (member.name or '')|lower }}"
             data-member-role="{{ (member.role or '')|lower }}">
          <div class="member-avatar"><i class="bi bi-person-circle"></i></div>

          <div class="member-info">
            <h4 class="member-name">{{ member.name or '—' }}</h4>
            <p class="member-email">
              <a href="mailto:{{ (member.email or '') }}">{{ member.email or '—' }}</a>
              <button class="btn btn-sm btn-outline-secondary copy-email-btn ms-2" data-email="{{ (member.email or '') }}" type="button" title="Copy email">
                <i class="bi bi-clipboard"></i>
              </button>
            </p>

            <div class="member-details">
              <span class="role-badge role-{{ (member.role or '')|lower|replace(' ', '-') }}">{{ member.role or 'Member' }}</span>
              <span class="join-date"><i class="bi bi-calendar3"></i> Joined {{ (member.join_date or '')[:10] }}</span>
            </div>
          </div>

          <div class="member-actions dropdown">
            <button class="btn btn-link p-0 text-muted" type="button" data-bs-toggle="dropdown">
              <i class="bi bi-three-dots-vertical"></i>
            </button>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item edit-role-btn" href="#" data-member-id="{{ member.id }}" data-current-role="{{ member.role }}"><i class="bi bi-pencil"></i> Change Role</a></li>
              <li><a class="dropdown-item text-danger remove-member-btn" href="#" data-member-id="{{ member.id }}" data-member-name="{{ member.name }}"><i class="bi bi-person-dash"></i> Remove Member</a></li>
            </ul>
          </div>
        </div>
        {% endfor %}
      {% else %}
        <div id="membersEmptyState" class="no-members-message text-center py-5 w-100">
          <i class="bi bi-people text-muted" style="font-size: 3rem;"></i>
          <h3 class="text-muted mt-3">No members found</h3>
          <p class="text-muted">There are no members matching your current filters. You can add a member or clear filters to see more results.</p>
          <div class="d-flex justify-content-center gap-2 mt-3">
            <button id="clearFilterBtn" class="btn btn-outline-secondary btn-sm">Clear Filter</button>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addMemberModal"><i class="bi bi-person-plus"></i> Add Member</button>
          </div>
        </div>
      {% endif %}
    </div>
  </div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay" style="display:none;">
  <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const clubId = "{{ club.id }}";
  const memberSearchInput = document.getElementById('memberSearchInput');
  const roleFilter = document.getElementById('roleFilter');
  const membersContainer = document.getElementById('membersContainer');
  const addMemberForm = document.getElementById('addMemberForm');
  const editRoleForm = document.getElementById('editRoleForm');
  const loadingOverlay = document.getElementById('loadingOverlay');
  let currentRemoveMemberId = null;

  function showLoading(){ loadingOverlay.style.display = 'flex'; }
  function hideLoading(){ loadingOverlay.style.display = 'none'; }
  function showAlert(message, type='success'){
    const d = document.createElement('div');
    d.className = `alert alert-${type==='error'?'danger':type} alert-dismissible fade show`;
    d.innerHTML = `${message} <button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
    document.querySelector('.roster-container').insertBefore(d, document.querySelector('.roster-container').firstChild);
    setTimeout(()=>{ if(d.parentNode) d.remove(); }, 5000);
  }
  function escapeHtml(s){ if(!s && s !== 0) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }

  // Render members or empty state
  function renderMembers(members){
    if(!members || members.length === 0){
      membersContainer.innerHTML = `
        <div id="membersEmptyState" class="no-members-message text-center py-5 w-100">
          <i class="bi bi-people text-muted" style="font-size: 3rem"></i>
          <h3 class="text-muted mt-3">No members found</h3>
          <p class="text-muted">Try clearing filters or add the first member.</p>
          <div class="d-flex justify-content-center gap-2 mt-3">
            <button id="clearFilterBtn" class="btn btn-outline-secondary btn-sm">Clear Filter</button>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addMemberModal"><i class="bi bi-person-plus"></i> Add Member</button>
          </div>
        </div>`;
      // wire clear filter button
      const clearBtn = document.getElementById('clearFilterBtn');
      if(clearBtn){
        clearBtn.addEventListener('click', function(){
          const url = new URL(window.location);
          url.searchParams.delete('role');
          history.pushState(null, '', url);
          if(roleFilter) roleFilter.value = '';
          fetchMembers('');
        });
      }
      updateStats(); return;
    }

    let html = '';
    members.forEach(m => {
      const id    = escapeHtml(m.id || '');
      const name  = escapeHtml(m.name || '—');
      const email = escapeHtml(m.email || '');
      const role  = escapeHtml(m.role || 'Member');
      const join  = escapeHtml((m.join_date || '').slice(0,10));
      const roleClass = role.toLowerCase().replace(/\s+/g,'-');
      html += `
<div class="member-card" data-member-id="${id}" data-member-name="${(name||'').toLowerCase()}" data-member-role="${(role||'').toLowerCase()}">
  <div class="member-avatar"><i class="bi bi-person-circle"></i></div>
  <div class="member-info">
    <h4 class="member-name">${name}</h4>
    <p class="member-email"><a href="mailto:${email}">${email}</a> <button class="btn btn-sm btn-outline-secondary copy-email-btn ms-2" data-email="${email}"><i class="bi bi-clipboard"></i></button></p>
    <div class="member-details">
      <span class="role-badge role-${roleClass}">${role}</span>
      <span class="join-date"><i class="bi bi-calendar3"></i> Joined ${join}</span>
    </div>
  </div>
  <div class="member-actions dropdown">
    <button class="btn btn-link p-0 text-muted" type="button" data-bs-toggle="dropdown"><i class="bi bi-three-dots-vertical"></i></button>
    <ul class="dropdown-menu">
      <li><a class="dropdown-item edit-role-btn" href="#" data-member-id="${id}" data-current-role="${role}"><i class="bi bi-pencil"></i> Change Role</a></li>
      <li><a class="dropdown-item text-danger remove-member-btn" href="#" data-member-id="${id}" data-member-name="${name}"><i class="bi bi-person-dash"></i> Remove Member</a></li>
    </ul>
  </div>
</div>`;
    });
    membersContainer.innerHTML = html;
    updateStats();
  }

  // fetch members via API
  function fetchMembers(role=''){
    let url = `/api/clubs/${clubId}/members`;
    if(role) url += `?role=${encodeURIComponent(role)}`;
    
    console.log(`Fetching members for club ${clubId}, role filter: ${role}`);
    showLoading();
    
    fetch(url).then(r=>r.json()).then(data=>{
      hideLoading();
      if(data.success) {
        console.log(`Got ${data.members.length} members in response:`, data.members);
        renderMembers(data.members);
      }
      else showAlert(data.error||'Failed to load members','error');
    }).catch(err=>{
      hideLoading();
      console.error(err);
      showAlert('Error loading members','error');
    });
  }

  // update stats summary based on DOM
  function updateStats(){
    const cards = document.querySelectorAll('.member-card');
    document.getElementById('statTotalMembers').textContent = cards.length;
    let officers = 0, regular = 0, latest = null;
    cards.forEach(c=>{
      const r = (c.dataset.memberRole||'').toLowerCase();
      if(r === 'member') regular++;
      if(['officer','president','vice president','treasurer','secretary'].includes(r)) officers++;
      const jt = c.querySelector('.join-date') ? c.querySelector('.join-date').textContent : '';
      const m = jt.match(/\d{4}-\d{2}-\d{2}/);
      if(m){ const d = new Date(m[0]); if(!isNaN(d.getTime()) && (!latest || d>latest)) latest = d; }
    });
    document.getElementById('statOfficers').textContent = officers;
    document.getElementById('statRegularMembers').textContent = regular;
    document.getElementById('statLatestJoin').textContent = latest ? latest.toISOString().slice(0,10) : 'N/A';
  }

  // role filter change -> update URL + fetch
  if(roleFilter){
    roleFilter.addEventListener('change', function(){
      const role = this.value || '';
      const url = new URL(window.location);
      if(role) url.searchParams.set('role', role); else url.searchParams.delete('role');
      history.pushState(null,'',url);
      fetchMembers(role);
    });
  }

  // handle back/forward
  window.addEventListener('popstate', function(){
    const url = new URL(window.location);
    const role = url.searchParams.get('role') || '';
    if(roleFilter) roleFilter.value = role;
    fetchMembers(role);
  });

  // simple client search
  if(memberSearchInput){
    memberSearchInput.addEventListener('input', function(){
      const q = this.value.toLowerCase().trim();
      document.querySelectorAll('.member-card').forEach(card=>{
        const name = card.dataset.memberName||'';
        const role = card.dataset.memberRole||'';
        card.style.display = (name.includes(q) || role.includes(q)) ? 'flex' : 'none';
      });
    });
  }

  // Add member (inline role required handled elsewhere)
  if(addMemberForm){
    addMemberForm.addEventListener('submit', function(e){
      e.preventDefault();
      const f = new FormData(this);
      const payload = { student_id: f.get('student_id'), role: f.get('role') };
      // inline check for role
      if(!payload.role){
        const roleEl = document.getElementById('memberRole');
        const fbEl = document.getElementById('memberRoleFeedback');
        if(roleEl){ roleEl.classList.add('is-invalid'); }
        if(fbEl){ fbEl.textContent = 'Please select a role.'; }
        return;
      }
      showLoading();
      fetch(`/api/clubs/${clubId}/members`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) })
        .then(r=>r.json()).then(resp=>{ hideLoading(); if(resp.success){ const modal = bootstrap.Modal.getInstance(document.getElementById('addMemberModal')); if(modal) modal.hide(); showAlert('Member added!','success'); fetchMembers(roleFilter?roleFilter.value:''); } else { showAlert(resp.error||'Failed','error'); } })
        .catch(err=>{ hideLoading(); console.error(err); showAlert('Error adding member','error'); });
    });
  }

  // delegated handlers for edit-role, remove-member and copy-email
  document.addEventListener('click', function(e){
    const editBtn = e.target.closest('.edit-role-btn');
    if(editBtn){ e.preventDefault(); const id = editBtn.dataset.memberId; const role = editBtn.dataset.currentRole || 'Member'; document.getElementById('editMemberId').value = id; document.getElementById('editMemberRole').value = role; const modal = new bootstrap.Modal(document.getElementById('editRoleModal')); modal.show(); return; }

    const removeBtn = e.target.closest('.remove-member-btn');
    if(removeBtn){ e.preventDefault(); currentRemoveMemberId = removeBtn.dataset.memberId; document.getElementById('removeMemberName').textContent = removeBtn.dataset.memberName || ''; const modal = new bootstrap.Modal(document.getElementById('removeMemberModal')); modal.show(); return; }

    const copyBtn = e.target.closest('.copy-email-btn');
    if(copyBtn){ const email = copyBtn.dataset.email || ''; if(navigator.clipboard && email){ navigator.clipboard.writeText(email).then(()=>showAlert('Email copied','success')).catch(()=>showAlert('Copy failed','error')); } else showAlert('No email to copy','info'); }
  });

  // Edit role submit handler
  if(editRoleForm){
    editRoleForm.addEventListener('submit', function(e){
      e.preventDefault();
      const memberId = document.getElementById('editMemberId').value;
      const newRole = document.getElementById('editMemberRole').value;
      if(!memberId || !newRole){ showAlert('Missing member or role','error'); return; }
      showLoading();
      fetch(`/api/clubs/${clubId}/members/${memberId}`, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ role: newRole }) })
        .then(r=>r.json()).then(resp=>{ hideLoading(); if(resp.success){ const modal = bootstrap.Modal.getInstance(document.getElementById('editRoleModal')); if(modal) modal.hide(); showAlert('Role updated','success'); fetchMembers(roleFilter?roleFilter.value:''); } else showAlert(resp.error||'Failed','error'); })
        .catch(err=>{ hideLoading(); console.error(err); showAlert('Error updating role','error'); });
    });
  }

  // Confirm remove: optimistic removal + rollback on failure
  const confirmRemoveBtn = document.getElementById('confirmRemoveBtn');
  if(confirmRemoveBtn){
    confirmRemoveBtn.addEventListener('click', function(){
      if(!currentRemoveMemberId) return;
      const card = document.querySelector(`.member-card[data-member-id="${currentRemoveMemberId}"]`);
      if(!card) return;
      const backup = card.cloneNode(true);
      const parent = membersContainer;
      const idx = Array.from(parent.children).indexOf(card);
      // optimistic remove
      card.remove();
      updateStats();
      showLoading();
      fetch(`/api/clubs/${clubId}/members/${currentRemoveMemberId}`, { method:'DELETE' })
        .then(r=>r.json()).then(resp=>{
          hideLoading();
          if(resp.success){
            const modal = bootstrap.Modal.getInstance(document.getElementById('removeMemberModal'));
            if(modal) modal.hide();
            showAlert('Member removed','success');
            fetchMembers(roleFilter?roleFilter.value:'');
          } else {
            // rollback
            if(idx >= parent.children.length) parent.appendChild(backup); else parent.insertBefore(backup, parent.children[idx]);
            updateStats();
            showAlert(resp.error||'Failed to remove','error');
          }
        }).catch(err=>{
          hideLoading();
          // rollback
          if(idx >= parent.children.length) parent.appendChild(backup); else parent.insertBefore(backup, parent.children[idx]);
          updateStats();
          console.error(err);
          showAlert('Error removing member','error');
        });
    });
  }

  // Handle quick filter buttons
  document.addEventListener('click', function(e) {
    const btn = e.target.closest('.quick-filter-btn');
    if (!btn) return;
    
    // Remove active class from all buttons
    document.querySelectorAll('.quick-filter-btn').forEach(b => 
      b.classList.remove('active', 'btn-primary', 'text-white'));
    
    // Add active class to clicked button
    btn.classList.add('active', 'btn-primary', 'text-white');
    
    const role = btn.dataset.role || '';
    console.log(`Quick filter clicked: ${role}`);
    
    // Update URL and filter
    const url = new URL(window.location);
    if(role) url.searchParams.set('role', role); else url.searchParams.delete('role');
    history.pushState(null, '', url);
    
    // Update dropdown to match
    if(roleFilter) roleFilter.value = role;
    
    // Fetch members with this role filter
    fetchMembers(role);
  });

  // Init: apply role filter if present or keep server rendered members
  (function init(){
    try{
      const url = new URL(window.location);
      const role = url.searchParams.get('role') || '';
      if(role){ 
        if(roleFilter) roleFilter.value = role; 
        // Highlight corresponding quick filter button
        document.querySelectorAll('.quick-filter-btn').forEach(btn => {
          if((btn.dataset.role || '') === role) {
            btn.classList.add('active', 'btn-primary', 'text-white');
          }
        });
        fetchMembers(role); 
      } else { 
        // Highlight "All" button
        document.querySelector('.quick-filter-btn[data-role=""]')?.classList.add('active', 'btn-primary', 'text-white');
        updateStats(); 
      }
    }catch(e){ 
      console.error(e);
      updateStats(); 
    }
  })();

});
</script>
{% endblock %}

